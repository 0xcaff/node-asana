<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: util/resource_stream.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: util/resource_stream.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var BufferedReadable = require('./buffered_readable');
var util = require('util');
var paging = require('./paging');

/**
 * A ResourceStream is a Node stream implementation for objects that are
 * fetched from the API. Basically, any promise for a collection of resources
 * from the API can be wrapped in this stream, and the stream will fetch
 * new pages of items as needed.
 *
 * @param {Dispatcher} dispatcher  Dispatcher to use for requests.
 * @param {Promise} promise        Promise for initial collection request.
 * @param {Object} dispatchOptions Dispatcher options to use for requests.
 * @constructor
 */

function ResourceStream(dispatcher, promise, dispatchOptions) {
  BufferedReadable.call(this, {
    objectMode: true
  });
  this.dispatcher = dispatcher;
  this.dispatchOptions = dispatchOptions;
  this.promise = promise;
  this._fetching = false;
}

util.inherits(ResourceStream, BufferedReadable);

ResourceStream.prototype._readUnbuffered = function() {
  console.log('calling _readUnbuffered');
  /* jshint camelcase:false */
  var me = this;
  if (!me.promise) {
    // No more resources to get.
    this.push(null);
    return;
  }

  // Avoid fetching more than the next page, in case a _read comes in
  // while we are still waiting for results.
  if (me._fetching) {
    return;
  }
  me._fetching = true;

  // When response comes back, we will push to stream.
  me.promise.then(function(response) {
    if (!response.data || response.data.length === undefined ||
        response.next_page === undefined) {
      // We got a successful response back but it did not appear to contain
      // an array of items. So maybe we did not fetch a collection.
      throw new Error('Response did not contain next page information');
    }
    response.data.forEach(function(resource) {
      me.pushBuffered(resource);
    });
    // Update promise to represent the next set of resources.
    me.promise = paging.nextPage(me.dispatcher, response, me.dispatchOptions);
    me._fetching = false;
  }).catch(function(error) {
    // Failure - emit error.
    me.emit('error', error);
  });
};

module.exports = ResourceStream;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="App.html">App</a></li><li><a href="Attachments.html">Attachments</a></li><li><a href="Authenticator.html">Authenticator</a></li><li><a href="BaseBrowserFlow.html">BaseBrowserFlow</a></li><li><a href="BasicAuthenticator.html">BasicAuthenticator</a></li><li><a href="BufferedReadable.html">BufferedReadable</a></li><li><a href="ChromeExtensionFlow.html">ChromeExtensionFlow</a></li><li><a href="Client.html">Client</a></li><li><a href="Dispatcher.html">Dispatcher</a></li><li><a href="Events.html">Events</a></li><li><a href="NativeFlow.html">NativeFlow</a></li><li><a href="OauthAuthenticator.html">OauthAuthenticator</a></li><li><a href="OauthError.html">OauthError</a></li><li><a href="PopupFlow.html">PopupFlow</a></li><li><a href="Projects.html">Projects</a></li><li><a href="RedirectFlow.html">RedirectFlow</a></li><li><a href="Resource.html">Resource</a></li><li><a href="ResourceStream.html">ResourceStream</a></li><li><a href="Stories.html">Stories</a></li><li><a href="Tags.html">Tags</a></li><li><a href="Tasks.html">Tasks</a></li><li><a href="Teams.html">Teams</a></li><li><a href="Users.html">Users</a></li><li><a href="Workspaces.html">Workspaces</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Tue Jan 20 2015 16:55:05 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
